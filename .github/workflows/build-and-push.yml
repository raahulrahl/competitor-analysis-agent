name: Build and Push to Docker Hub

on:
  push:
    branches:
      - main
    paths:
      - 'Dockerfile.agent'
      - 'competitor_analysis_agent/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.version'
      - '.github/workflows/build-and-push.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_REPOSITORY: para5/competitor-analysis-agent

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME || 'para5' }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Read version
        id: version
        run: |
          echo "version=$(cat .version | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.agent
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKER_REPOSITORY }}:latest
            ${{ env.DOCKER_REPOSITORY }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKER_REPOSITORY }}:build-${{ github.run_number }}
            ${{ env.DOCKER_REPOSITORY }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_REPOSITORY }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REPOSITORY }}:buildcache,mode=max

      - name: Read agent config and skills
        id: read_config
        run: |
          # Read agent config
          echo "config=$(cat competitor_analysis_agent/agent_config.json | jq -c .)" >> $GITHUB_OUTPUT
          echo "version=$(cat .version | tr -d '\n')" >> $GITHUB_OUTPUT

          # Read all skills from the skills folder and write to a file
          skills_array="[]"
          for skill_dir in competitor_analysis_agent/skills/*/; do
            if [ -f "${skill_dir}skill.yaml" ]; then
              skill_json=$(cat "${skill_dir}skill.yaml" | yq -o=json | jq -c .)
              skills_array=$(echo "$skills_array" | jq --argjson skill "$skill_json" '. += [$skill]')
            fi
          done

          # Write skills to a file instead of passing as output variable
          echo "$skills_array" > /tmp/skills.json

          # Write environment variables to a file
          cat competitor_analysis_agent/agent_config.json | jq '.environment_variables // []' > /tmp/env_vars.json

          # Write execution cost to a file
          cat competitor_analysis_agent/agent_config.json | jq '.execution_cost // {}' > /tmp/exec_cost.json

          # Write auth to a file
          cat competitor_analysis_agent/agent_config.json | jq '.auth // {}' > /tmp/auth.json

      - name: Log to backend service
        env:
          BINDU_API_TOKEN: ${{ secrets.BINDU_API_TOKEN }}
        run: |
          # Read the config values
          AGENT_NAME=$(cat competitor_analysis_agent/agent_config.json | jq -r '.name')
          AGENT_AUTHOR=$(cat competitor_analysis_agent/agent_config.json | jq -r '.author')
          AGENT_DESCRIPTION=$(cat competitor_analysis_agent/agent_config.json | jq -r '.description')
          AGENT_TRUST=$(cat competitor_analysis_agent/agent_config.json | jq -r '.agent_trust')
          DEPLOYMENT_URL=$(cat competitor_analysis_agent/agent_config.json | jq -r '.deployment.url')
          DEPLOYMENT_PROTOCOL=$(cat competitor_analysis_agent/agent_config.json | jq -r '.deployment.protocol_version')
          METADATA_DOMAIN=$(cat competitor_analysis_agent/agent_config.json | jq -r '.metadata.domain // "general"')
          METADATA_SPECIALIZATION=$(cat competitor_analysis_agent/agent_config.json | jq -r '.metadata.specialization // "multi-purpose"')
          VERSION=$(cat .version | tr -d '\n')

          # Create the final JSON payload using jq with file inputs
          jq -n \
            --arg name "$AGENT_NAME" \
            --arg author "$AGENT_AUTHOR" \
            --arg description "$AGENT_DESCRIPTION" \
            --arg version "$VERSION" \
            --arg agent_trust "$AGENT_TRUST" \
            --slurpfile skills /tmp/skills.json \
            --slurpfile env_vars /tmp/env_vars.json \
            --slurpfile exec_cost /tmp/exec_cost.json \
            --slurpfile auth /tmp/auth.json \
            --arg url "$DEPLOYMENT_URL" \
            --arg protocol_version "$DEPLOYMENT_PROTOCOL" \
            --arg docker_image "${{ env.DOCKER_REPOSITORY }}:latest" \
            --arg digest "${{ steps.docker_build.outputs.digest }}" \
            --arg repo_url "https://github.com/${{ github.repository }}" \
            --arg commit_sha "${{ github.sha }}" \
            --arg build_number "${{ github.run_number }}" \
            --arg docs_url "https://github.com/Paraschamoli/competitor-analysis-agent#readme" \
            --arg domain "$METADATA_DOMAIN" \
            --arg specialization "$METADATA_SPECIALIZATION" \
            --arg last_updated "${{ github.event.head_commit.timestamp }}" \
            '{
              "agent": {
                "name": $name,
                "author": $author,
                "description": $description,
                "version": $version,
                "agent_trust": $agent_trust,
                "type": "research"
              },
              "skills": ($skills[0] // []),
              "framework": {
                "name": "agno",
                "version": "1.0.0"
              },
              "environment_variables": ($env_vars[0] // []),
              "execution_cost": ($exec_cost[0] // {}),
              "auth": ($auth[0] // {}),
              "deployment": {
                "url": $url,
                "protocol_version": $protocol_version,
                "docker_image": $docker_image,
                "docker_digest": $digest,
                "platforms": ["linux/amd64", "linux/arm64"]
              },
              "repository": {
                "url": $repo_url,
                "commit_sha": $commit_sha,
                "build_number": $build_number
              },
              "metadata": {
                "documentation_url": $docs_url,
                "domain": $domain,
                "specialization": $specialization,
                "last_updated": $last_updated
              }
            }' > /tmp/final_payload.json

          # Send the request
          curl --location 'https://bindus.getbindu.com/bindu-register' \
            --header 'accept: application/json' \
            --header 'X-Bindu-CI: true' \
            --header "X-API-Token: $BINDU_API_TOKEN" \
            --header 'Content-Type: application/json' \
            --data @/tmp/final_payload.json
