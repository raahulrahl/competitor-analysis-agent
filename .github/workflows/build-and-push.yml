name: Build and Push to Docker Hub

on:
  push:
    branches:
      - main
    paths:
      - 'Dockerfile.agent'
      - 'competitor_analysis_agent/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - '.version'
      - '.github/workflows/build-and-push.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_REPOSITORY: para5/competitor-analysis-agent

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME || 'para5' }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Read version
        id: version
        run: |
          echo "version=$(cat .version | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.agent
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.DOCKER_REPOSITORY }}:latest
            ${{ env.DOCKER_REPOSITORY }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKER_REPOSITORY }}:build-${{ github.run_number }}
            ${{ env.DOCKER_REPOSITORY }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_REPOSITORY }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REPOSITORY }}:buildcache,mode=max

      - name: Read agent config
        id: agent_config
        run: |
          echo "config=$(cat competitor_analysis_agent/agent_config.json | jq -c .)" >> $GITHUB_OUTPUT
          echo "version=$(cat .version | tr -d '\n')" >> $GITHUB_OUTPUT

          # Read all skills from the skills folder
          skills_array="[]"
          for skill_dir in competitor_analysis_agent/skills/*/; do
            if [ -f "${skill_dir}skill.yaml" ]; then
              skill_json=$(cat "${skill_dir}skill.yaml" | yq -o=json | jq -c .)
              skills_array=$(echo "$skills_array" | jq --argjson skill "$skill_json" '. += [$skill]')
            fi
          done
          # Escape the skills JSON properly for shell
          skills_escaped=$(echo "$skills_array" | jq -c . | sed 's/"/\\"/g' | sed 's/\\n/\\\\n/g')
          echo "skills=$skills_escaped" >> $GITHUB_OUTPUT

      - name: Log to backend service
        env:
          BINDU_API_TOKEN: ${{ secrets.BINDU_API_TOKEN }}
        run: |
          # Create a temporary file with the JSON payload
          cat > /tmp/payload.json << 'EOF'
          {
            "agent": {
              "name": "${{ fromJson(steps.agent_config.outputs.config).name }}",
              "author": "${{ fromJson(steps.agent_config.outputs.config).author }}",
              "description": "${{ fromJson(steps.agent_config.outputs.config).description }}",
              "version": "${{ steps.agent_config.outputs.version }}",
              "agent_trust": "${{ fromJson(steps.agent_config.outputs.config).agent_trust }}",
              "type": "research"
            },
            "skills": ${{ steps.agent_config.outputs.skills }},
            "framework": {
              "name": "agno",
              "version": "1.0.0"
            },
            "environment_variables": ${{ toJson(fromJson(steps.agent_config.outputs.config).environment_variables) }},
            "execution_cost": ${{ toJson(fromJson(steps.agent_config.outputs.config).execution_cost || fromJson('{}')) }},
            "auth": ${{ toJson(fromJson(steps.agent_config.outputs.config).auth || fromJson('{}')) }},
            "deployment": {
              "url": "${{ fromJson(steps.agent_config.outputs.config).deployment.url }}",
              "protocol_version": "${{ fromJson(steps.agent_config.outputs.config).deployment.protocol_version }}",
              "docker_image": "${{ env.DOCKER_REPOSITORY }}:latest",
              "docker_digest": "${{ steps.docker_build.outputs.digest }}",
              "platforms": ["linux/amd64", "linux/arm64"]
            },
            "repository": {
              "url": "https://github.com/${{ github.repository }}",
              "commit_sha": "${{ github.sha }}",
              "build_number": "${{ github.run_number }}"
            },
            "metadata": {
              "documentation_url": "https://Paraschamoli.github.io/competitor-analysis-agent/",
              "domain": "${{ fromJson(steps.agent_config.outputs.config).metadata.domain || 'general' }}",
              "specialization": "${{ fromJson(steps.agent_config.outputs.config).metadata.specialization || 'multi-purpose' }}",
              "last_updated": "${{ github.event.head_commit.timestamp }}"
            }
          }
          EOF

          # Use jq to process the template and replace variables
          jq \
            --arg name "${{ fromJson(steps.agent_config.outputs.config).name }}" \
            --arg author "${{ fromJson(steps.agent_config.outputs.config).author }}" \
            --arg description "${{ fromJson(steps.agent_config.outputs.config).description }}" \
            --arg version "${{ steps.agent_config.outputs.version }}" \
            --arg agent_trust "${{ fromJson(steps.agent_config.outputs.config).agent_trust }}" \
            --argjson skills "${{ steps.agent_config.outputs.skills }}" \
            --argjson env_vars "${{ toJson(fromJson(steps.agent_config.outputs.config).environment_variables) }}" \
            --argjson exec_cost "${{ toJson(fromJson(steps.agent_config.outputs.config).execution_cost || fromJson('{}')) }}" \
            --argjson auth "${{ toJson(fromJson(steps.agent_config.outputs.config).auth || fromJson('{}')) }}" \
            --arg url "${{ fromJson(steps.agent_config.outputs.config).deployment.url }}" \
            --arg protocol_version "${{ fromJson(steps.agent_config.outputs.config).deployment.protocol_version }}" \
            --arg docker_image "${{ env.DOCKER_REPOSITORY }}:latest" \
            --arg digest "${{ steps.docker_build.outputs.digest }}" \
            --arg repo_url "https://github.com/${{ github.repository }}" \
            --arg commit_sha "${{ github.sha }}" \
            --arg build_number "${{ github.run_number }}" \
            --arg docs_url "https://Paraschamoli.github.io/competitor-analysis-agent/" \
            --arg domain "${{ fromJson(steps.agent_config.outputs.config).metadata.domain || 'general' }}" \
            --arg specialization "${{ fromJson(steps.agent_config.outputs.config).metadata.specialization || 'multi-purpose' }}" \
            --arg last_updated "${{ github.event.head_commit.timestamp }}" \
            '.agent.name = $name
             | .agent.author = $author
             | .agent.description = $description
             | .agent.version = $version
             | .agent.agent_trust = $agent_trust
             | .skills = $skills
             | .environment_variables = $env_vars
             | .execution_cost = $exec_cost
             | .auth = $auth
             | .deployment.url = $url
             | .deployment.protocol_version = $protocol_version
             | .deployment.docker_image = $docker_image
             | .deployment.docker_digest = $digest
             | .repository.url = $repo_url
             | .repository.commit_sha = $commit_sha
             | .repository.build_number = $build_number
             | .metadata.documentation_url = $docs_url
             | .metadata.domain = $domain
             | .metadata.specialization = $specialization
             | .metadata.last_updated = $last_updated' /tmp/payload.json > /tmp/final_payload.json

          # Send the request
          curl --location 'https://bindus.getbindu.com/bindu-register' \
            --header 'accept: application/json' \
            --header 'X-Bindu-CI: true' \
            --header "X-API-Token: $BINDU_API_TOKEN" \
            --header 'Content-Type: application/json' \
            --data @/tmp/final_payload.json
